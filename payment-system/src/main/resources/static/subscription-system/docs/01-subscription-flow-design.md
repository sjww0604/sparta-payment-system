# 구독 기반 결제 플로우 설계

## 목적

구독 기반 결제 시스템의 핵심 플로우를 설계하여 다음과 같은 목적을 달성합니다:

- **구독 플랜 관리**: 다양한 구독 플랜을 생성하고 관리
- **빌링키 기반 정기 결제**: PortOne 빌링키를 활용한 자동 정기 결제 처리
- **체험 기간 관리**: 체험 기간 제공 및 자동 전환 처리
- **구독 상태 관리**: 구독의 생명주기(체험, 활성, 연체, 취소, 종료) 관리
- **자동 정기 결제**: 스케줄러를 통한 정기 결제 자동화
- **구독 취소**: 구독 취소 처리

## 결제 플로우 상세 설명

### 1. 빌링키 발급 및 결제 수단 등록 플로우

**처리 단계**:
1. 사용자가 결제 수단 등록 요청
2. 프론트엔드에서 PortOne 빌링키 발급 API 호출
3. 빌링키 발급 시 초기 결제 처리 (최소 1,000원)
4. 빌링키 및 카드 정보 저장
5. 결제 수단 등록 완료

**주요 데이터**:
- 고객 고유 ID (customerUid)
- 빌링키 (billingKey)
- 카드 브랜드 (cardBrand)
- 카드 마지막 4자리 (last4)
- 기본 결제 수단 여부 (isDefault)

**처리 흐름**:
```
[사용자] 
   │
   ├─> [1. 빌링키 발급 요청]
   │      │
   │      ├─> 프론트엔드: PortOne.requestIssueBillingKey() 호출
   │      ├─> 초기 결제 처리 (최소 1,000원)
   │      ├─> 빌링키 발급 완료
   │      └─> 카드 정보 수신
   │
   ├─> [2. 결제 수단 등록]
   │      │
   │      ├─> customerUid 중복 체크
   │      ├─> 기본 결제 수단 설정 시 기존 기본 해제
   │      ├─> 결제 수단 정보 저장
   │      └─> 등록 완료
   │
   └─> [3. 결제 수단 조회/관리]
          │
          ├─> 사용자별 결제 수단 목록 조회
          ├─> 기본 결제 수단 변경
          └─> 결제 수단 삭제
```

---

### 2. 구독 생성 플로우

**처리 단계**:

#### 2-1. 구독 생성 전 검증
- 사용자 존재 확인
- 플랜 존재 및 활성 상태 확인
- 결제 수단 소유권 확인 (선택적)

#### 2-2. 구독 정보 생성
- 구독 상태 결정 (체험 기간 여부에 따라 `TRIALING` 또는 `ACTIVE`)
- 현재 기간 시작일/종료일 계산
- 체험 종료일 계산 (체험 기간이 있는 경우)

#### 2-3. 초기 결제 처리
- 체험 기간이 없는 경우: 즉시 첫 결제 처리
- 체험 기간이 있는 경우: 체험 종료일까지 대기

#### 2-4. 예약결제 스케줄 생성
- PortOne 예약결제 스케줄 생성
- 빌링 주기(monthly/yearly)에 따라 반복 결제 스케줄 설정
- 첫 결제 예정일: 체험 종료일 또는 다음 기간 시작일

**주요 데이터**:
- 구독 ID (subscriptionId)
- 사용자 ID (userId)
- 플랜 ID (planId)
- 결제 수단 ID (paymentMethodId)
- 구독 상태 (status)
- 현재 기간 시작일/종료일 (currentPeriodStart/End)
- 체험 종료일 (trialEnd)

**처리 흐름**:
```
[사용자] 
   │
   ├─> [1. 구독 생성 요청]
   │      │
   │      ├─> 사용자/플랜/결제 수단 검증
   │      ├─> 구독 정보 생성
   │      │   ├─> 상태: TRIALING (체험 있음) 또는 ACTIVE (체험 없음)
   │      │   ├─> 기간 계산 (billingInterval 기준)
   │      │   └─> 체험 종료일 설정 (체험 기간이 있는 경우)
   │      │
   │      ├─> [체험 기간 없음]
   │      │   └─> 즉시 첫 결제 처리
   │      │
   │      ├─> [체험 기간 있음]
   │      │   └─> 체험 종료일까지 대기
   │      │
   │      └─> 예약결제 스케줄 생성
   │          ├─> PortOne 스케줄 생성 API 호출
   │          ├─> 빌링 주기 설정 (monthly/yearly)
   │          └─> 첫 결제 예정일 설정
```

---

### 3. 정기 결제 처리 플로우 (스케줄러 기반)

**처리 단계**:

#### 3-1. 스케줄러 실행 (매일 자정)
- `current_period_end`가 오늘 또는 과거인 활성 구독 조회
- 상태: `ACTIVE` 또는 `PAST_DUE`

#### 3-2. 결제 처리
- 등록된 결제 수단 확인
- PortOne 정기결제 실행 (빌링키 사용)
- **성공 시**:
  - `imp_uid` 저장
  - 결제 완료 시간 저장
  - 구독 기간 연장 (다음 기간 시작일/종료일 업데이트)
  - 구독 상태: `ACTIVE`
- **실패 시**:
  - 실패 사유 저장
  - 구독 상태: `PAST_DUE`

#### 3-3. 체험 기간 종료 처리 (매 시간 실행)
- 체험 기간이 종료된 `TRIALING` 상태 구독 조회
- 구독 상태를 `ACTIVE`로 변경
- 첫 결제 처리

**처리 흐름**:
```
[스케줄러 - 매일 자정]
   │
   ├─> [1. 만료 예정 구독 조회]
   │      │
   │      └─> current_period_end <= 오늘
   │          AND status IN (ACTIVE, PAST_DUE)
   │
   ├─> [2. 결제 처리]
   │      │
   │      ├─> 결제 수단 확인
   │      ├─> PortOne 정기결제 실행
   │      │
   │      ├─> [성공]
   │      │   ├─> imp_uid 저장
   │      │   ├─> 구독 기간 연장
   │      │   └─> 구독 상태: ACTIVE
   │      │
   │      └─> [실패]
   │          ├─> 실패 사유 저장
   │          └─> 구독 상태: PAST_DUE
   │
   └─> [3. 체험 기간 종료 처리 (매 시간)]
          │
          ├─> trial_end <= 현재 시간
          ├─> AND status = TRIALING
          ├─> 구독 상태: ACTIVE로 변경
          └─> 첫 결제 처리
```

---

### 4. 구독 취소 플로우

**처리 단계**:

#### 4-1. 구독 취소 요청 검증
- 구독 존재 확인
- 사용자 소유권 확인
- 이미 취소/종료된 구독인지 확인

#### 4-2. 예약결제 스케줄 삭제
- PortOne 예약결제 스케줄 조회
- 구독과 연결된 모든 스케줄 삭제
- 스케줄 삭제 실패 시에도 구독 취소는 진행 (로그만 남김)

#### 4-3. 구독 상태 변경
- 구독 상태: `CANCELED`
- 취소 시간 저장 (`canceledAt`)
- 구독 종료 시간은 현재 기간 종료일까지 유지

**처리 흐름**:
```
[사용자] 
   │
   ├─> [1. 구독 취소 요청]
   │      │
   │      ├─> 구독/사용자 검증
   │      ├─> 취소 가능 여부 확인
   │      │
   │      ├─> [2. 예약결제 스케줄 삭제]
   │      │      │
   │      │      ├─> PortOne 스케줄 조회
   │      │      ├─> 구독과 연결된 스케줄 찾기
   │      │      └─> 모든 스케줄 삭제
   │      │
      └─> [3. 구독 상태 변경]
             │
             ├─> 상태: CANCELED
             ├─> canceledAt 저장
             └─> endedAt은 current_period_end까지 유지
```

---

## 구독 플로우 다이어그램

```
[사용자] 
   │
   ├─> [1. 빌링키 발급 및 결제 수단 등록]
   │      │
   │      ├─> 프론트엔드: PortOne 빌링키 발급
   │      ├─> 초기 결제 처리 (최소 1,000원)
   │      ├─> 결제 수단 정보 저장
   │      └─> 등록 완료
   │
   ├─> [2. 구독 생성]
   │      │
   │      ├─> 플랜 선택
   │      ├─> 결제 수단 선택 (선택적)
   │      ├─> 구독 정보 생성
   │      │   ├─> [체험 기간 있음] → TRIALING
   │      │   └─> [체험 기간 없음] → ACTIVE (즉시 결제)
   │      │
   │      └─> 예약결제 스케줄 생성
   │          └─> PortOne 스케줄 등록
   │
   ├─> [3. 정기 결제 (스케줄러)]
   │      │
   │      ├─> [매일 자정] 만료 예정 구독 조회
   │      ├─> PortOne 정기결제 실행
   │      │
   │      ├─> [성공]
   │      │   ├─> 구독 기간 연장
   │      │   └─> 구독 상태: ACTIVE
   │      │
   │      └─> [실패]
   │          └─> 구독 상태: PAST_DUE
   │
   ├─> [4. 체험 기간 종료 처리 (매 시간)]
   │      │
   │      ├─> 체험 종료된 구독 조회
   │      ├─> 구독 상태: ACTIVE로 변경
   │      └─> 첫 결제 처리
   │
   └─> [5. 구독 취소]
          │
          ├─> 예약결제 스케줄 삭제
          └─> 구독 상태: CANCELED
```

---

## 주요 고려사항

### 1. 트랜잭션 관리
- 구독 생성, 결제 처리는 각각 독립적인 트랜잭션으로 관리
- 결제 실패 시 구독 상태만 변경
- 예약결제 스케줄 생성 실패 시에도 구독은 생성됨 (비동기 처리)

### 2. 빌링키 관리
- **빌링키 발급**: 프론트엔드에서 PortOne.requestIssueBillingKey() 사용 권장
- **빌링키 저장**: customerUid와 함께 결제 수단에 저장
- **빌링키 조회**: PortOne API를 통해 빌링키 정보 조회 (재시도 로직 포함)
- **빌링키 검증**: 결제 실행 전 빌링키 존재 여부 확인

### 3. 구독 상태 관리

#### 구독 상태 (SubscriptionStatus)
- `TRIALING`: 체험 중 (체험 기간 동안)
- `ACTIVE`: 활성 (정상 결제 중)
- `PAST_DUE`: 결제 연체 (결제 실패 시)
- `CANCELED`: 취소됨 (사용자가 취소 요청)
- `ENDED`: 종료됨 (현재 기간 종료 후)

#### 구독 상태 변화
```
생성 → TRIALING (체험 있음) → ACTIVE → [결제 실패] → PAST_DUE
                    ↓
              [체험 없음] → ACTIVE → [정기 결제 성공] → ACTIVE
                    ↓
              [취소 요청] → CANCELED → [기간 종료] → ENDED
```

### 4. 체험 기간 관리
- **체험 기간 설정**: 플랜별로 `trialPeriodDays` 설정 가능
- **체험 기간 중**: 구독 상태는 `TRIALING`, 결제 없음
- **체험 종료**: 스케줄러가 매 시간마다 체크하여 `ACTIVE`로 전환 및 첫 결제 처리
- **체험 기간 없음**: 구독 생성 시 즉시 첫 결제 처리

### 5. 예약결제 스케줄 관리
- **스케줄 생성**: 구독 생성 시 PortOne 예약결제 스케줄 생성
- **스케줄 삭제**: 구독 취소 시 연결된 모든 스케줄 삭제
- **스케줄 매칭**: metadata의 subscriptionId 또는 paymentId 패턴으로 매칭
- **스케줄 조회**: customerUid로 모든 스케줄 조회

### 6. 에러 처리 플로우
- **빌링키 없음**: 결제 수단에 빌링키가 없으면 결제 실패
- **결제 실패**: 구독 상태를 `PAST_DUE`로 변경
- **스케줄 삭제 실패**: 로그만 남기고 구독 취소는 진행

### 7. 재시도 로직
- **빌링키 조회**: 404 에러 시 최대 3회 재시도 (2초 간격)
- **자동 재시도**: 스케줄러가 매일 만료 예정 구독을 다시 처리

---

## 플로우별 상태 변화

### 구독 상태 변화
```
[구독 생성]
  ├─> [체험 기간 있음] → TRIALING
  │       │
  │       └─> [체험 종료] → ACTIVE
  │
  └─> [체험 기간 없음] → ACTIVE
          │
          ├─> [정기 결제 성공] → ACTIVE (기간 연장)
          │
          └─> [결제 실패] → PAST_DUE
                  │
                  └─> [결제 성공] → ACTIVE
                          │
                          └─> [취소 요청] → CANCELED
                                  │
                                  └─> [기간 종료] → ENDED
```

### 결제 수단 상태
```
[빌링키 발급] → 등록 완료
    │
    ├─> [기본 결제 수단 설정]
    │
    ├─> [결제 실행] → 성공/실패
    │
    └─> [결제 수단 삭제] → 삭제 완료
```

---

## 스케줄러 동작 상세

### 1. 정기 결제 스케줄러 (매일 자정)
- **실행 시간**: 매일 00:00:00
- **처리 대상**: `current_period_end <= 현재 시간` AND `status IN (ACTIVE, PAST_DUE)`
- **처리 내용**:
  1. 만료 예정 구독 조회
  2. 결제 처리 (비동기)
  3. 성공/실패 로그 기록

### 2. 체험 기간 종료 처리 스케줄러 (매 시간)
- **실행 시간**: 매 시간 00분
- **처리 대상**: `trial_end <= 현재 시간` AND `status = TRIALING`
- **처리 내용**:
  1. 체험 종료된 구독 조회
  2. 구독 상태를 `ACTIVE`로 변경
  3. 첫 결제 처리

---

## 참고사항

- **API 엔드포인트 상세 정보**: `01-api-endpoints.md` 파일 참고
- **데이터베이스 스키마**: `00-dbdiagram.md` 파일 참고
- **PortOne API 문서**: 
  - 빌링키 발급: https://developers.portone.io/opi/ko/integration/start/v2/billing/issue?v=v2
  - 예약결제 스케줄: https://developers.portone.io/opi/ko/integration/start/v2/billing/schedule?v=v2
- **트랜잭션 관리**: 구독 생성, 결제 처리는 각각 독립적인 트랜잭션으로 관리
- **비동기 처리**: 예약결제 스케줄 생성/삭제는 비동기로 처리되며, 실패해도 구독 생성은 완료됨
- **재시도 로직**: 빌링키 조회 시 404 에러는 최대 3회 재시도 (2초 간격)

