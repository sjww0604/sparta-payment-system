# 포인트 기반 결제 플로우 설계

## 목적

포인트 기반 결제 시스템의 핵심 플로우를 설계하여 다음과 같은 목적을 달성합니다:

- **주문 생성 및 관리**: 사용자의 주문 정보를 체계적으로 관리하고 주문번호를 부여
- **포인트 통합 결제**: 포인트 사용과 외부 결제 수단을 통합하여 결제 처리
- **멤버십 등급 관리**: 사용자의 멤버십 등급에 따라 차등화된 포인트 적립률 적용
- **결제 상태 관리**: 결제 성공/실패를 시뮬레이션하고 상태를 추적
- **주문 조회**: 생성된 주문의 상세 정보를 조회할 수 있는 API 제공

## 결제 플로우 상세 설명

### 1. 주문 생성 플로우

**처리 단계**:
1. 주문번호 생성 (포인트가 있기 때문에 orderID와 포트원 payment-시간정보 id를 분리해서 관리합니다.)
2. 주문 총액 계산 (포인트 할인 반영)
3. 주문 아이템 정보 저장
4. 주문 상태를 `PENDING_PAYMENT`로 설정

**주요 데이터**:
- 주문번호 (orderId)
- 사용자 ID (userId)
- 주문 총액 (totalAmount)
- 사용한 포인트 (pointsUsed)
- 포인트 할인 금액 (pointsDiscountAmount)
- 주문 아이템 목록 (orderItems)

---

### 2. 결제 처리 플로우

**처리 단계**:

#### 2-1. 포인트 사용 처리 (선택사항)
- 사용자가 포인트를 사용한 경우, 포인트 차감 처리
- 포인트 잔액 부족 시 결제 실패 반환
- 포인트 사용 금액만큼 최종 결제 금액에서 차감

#### 2-2. 주문 생성/업데이트
- 주문 정보 저장
- 주문 아이템 저장
- 주문 상태는 `PENDING_PAYMENT` 유지

#### 2-3. 결제 처리 시뮬레이션
- 성공/실패 결정
- **성공 시**:
  - 결제 상태를 `PAID`로 변경
  - 주문 상태를 `COMPLETED`로 변경
  - 멤버십 등급 조회 및 포인트 적립 처리
  - 멤버십 등급 자동 업데이트 (총 결제 금액 기준)
- **실패 시**:
  - 결제 상태를 `FAILED`로 유지
  - 주문 상태는 `PENDING_PAYMENT` 유지
  - 사용한 포인트 복구 (롤백)

#### 2-4. 포인트 적립 처리 (결제 성공 시)
- 사용자의 멤버십 등급에 따라 차등화된 포인트 적립률 적용
- 멤버십 등급별 적립률:
  - **Normal (일반 등급)**: 1% 적립
  - **VIP (우수 등급)**: 5% 적립
  - **VVIP (최우수 등급)**: 10% 적립
- 적립 포인트 = 결제 금액 × 멤버십 등급별 적립률
- 적립된 포인트는 포인트 거래 내역에 기록

#### 2-5. 멤버십 등급 자동 업데이트 (결제 성공 시)
- 총 결제 금액 재계산 (PAID 상태의 결제만 집계)
- 총 결제 금액에 따른 등급 결정:
  - 5만원 이하: Normal
  - 10만원 이하: VIP
  - 15만원 이상: VVIP
- 사용자의 멤버십 등급 자동 업데이트

---

### 3. 주문 조회 플로우

**처리 단계**:
1. 주문 기본 정보 조회
2. 주문 아이템 목록 조회
3. 결제 정보 조회 (연결된 Payment 엔티티)
4. 포인트 사용 내역 조회
5. 적립 포인트 정보 포함

**반환 정보**:
- 주문 기본 정보 (주문번호, 사용자 ID, 총액, 상태 등)
- 주문 아이템 목록
- 결제 정보 (결제 금액, 결제 방법, 결제 상태 등)
- 포인트 사용/적립 내역

---

## 결제 플로우 다이어그램

```
[사용자] 
   │
   ├─> [1. 주문 생성]
   │      │
   │      ├─> 주문번호 생성
   │      ├─> 주문 총액 계산 (포인트 할인 반영)
   │      ├─> 주문 아이템 저장
   │      └─> 주문 상태: PENDING_PAYMENT
   │
   ├─> [2. 결제 요청]
   │      │
   │      ├─> 포인트 사용 처리 (선택)
   │      │   ├─> 포인트 잔액 확인
   │      │   └─> 포인트 차감
   │      │
   │      ├─> 주문 정보 저장/업데이트
   │      │
   │      ├─> 결제 처리 시뮬레이션
   │      │   │
   │      │   ├─> [성공]
   │      │   │   ├─> 결제 상태: PAID
   │      │   │   ├─> 주문 상태: COMPLETED
   │      │   │   ├─> 멤버십 등급 조회
   │      │   │   ├─> 포인트 적립 (등급별 적립률 적용)
   │      │   │   │   ├─> Normal: 1%
   │      │   │   │   ├─> VIP: 5%
   │      │   │   │   └─> VVIP: 10%
   │      │   │   └─> 멤버십 등급 자동 업데이트
   │      │   │       (총 결제 금액 기준)
   │      │   │
   │      │   └─> [실패]
   │      │       ├─> 결제 상태: FAILED
   │      │       ├─> 주문 상태: PENDING_PAYMENT 유지
   │      │       └─> 포인트 복구 (롤백)
   │      │
   │      └─> 결제 결과 반환
   │
   ├─> [3. 주문 조회]
   │      │
   │      └─> 주문 상세 정보 반환
   │          (주문 정보 + 주문 아이템 + 결제 정보 + 적립 포인트)
   │
   └─> [4. 결제 취소/환불]
          │
          ├─> 결제 상태 확인
          ├─> 포인트 환불 (사용한 포인트 복구)
          ├─> 포인트 적립 취소 (적립된 포인트 차감)
          ├─> 주문 상태: CANCELLED
          ├─> 결제 상태: REFUNDED
          └─> 멤버십 등급 자동 업데이트
              (총 결제 금액 재계산 후 등급 재조정)
```

---

## 주요 고려사항

### 1. 트랜잭션 관리
- 주문 생성, 포인트 차감, 결제 처리는 하나의 트랜잭션으로 관리
- 결제 실패 시 모든 변경사항 롤백 (포인트 복구 포함)

### 2. 포인트 처리
- **포인트 사용**: 결제 전에 포인트 차감 처리
- **포인트 적립**: 결제 성공 시에만 포인트 적립
  - 멤버십 등급에 따라 차등화된 적립률 적용
  - Normal: 1%, VIP: 5%, VVIP: 10%
- **포인트 복구**: 결제 실패 시 사용한 포인트 자동 복구

### 2-1. 멤버십 등급 관리 정책

#### 등급별 포인트 적립률
| 등급 | 등급명 | 적립률 | 설명 |
|------|--------|--------|------|
| 1 | Normal (일반 등급) | 1% | 기본 등급, 모든 사용자에게 기본 부여 |
| 2 | VIP (우수 등급) | 5% | 일정 조건 충족 시 승급 (예: 누적 구매 금액 100만원 이상) |
| 3 | VVIP (최우수 등급) | 10% | 최고 등급, 특별 조건 충족 시 승급 (예: 누적 구매 금액 500만원 이상) |

#### 포인트 적립 계산 예시
- **Normal 등급 사용자**: 50,000원 결제 → 500포인트 적립 (50,000 × 0.01)
- **VIP 등급 사용자**: 50,000원 결제 → 2,500포인트 적립 (50,000 × 0.05)
- **VVIP 등급 사용자**: 50,000원 결제 → 5,000포인트 적립 (50,000 × 0.10)

#### 멤버십 등급 조회 및 적용 플로우
1. 결제 성공 시 사용자의 멤버십 정보 조회
2. 멤버십 등급의 `point_accrual_rate` 값 확인
3. 결제 금액에 적립률을 곱하여 적립 포인트 계산
4. 계산된 포인트를 사용자에게 적립
5. 총 결제 금액 재계산 후 멤버십 등급 자동 업데이트

#### 멤버십 등급 자동 갱신 플로우
- **결제 완료 시**: 총 결제 금액 증가 → 등급 재계산 → 등급 업데이트
- **결제 취소 시**: 총 결제 금액 감소 → 등급 재계산 → 등급 다운그레이드 가능
  - 예: VVIP(15만원 이상) → VIP(10만원 이하) → Normal(5만원 이하)

### 3. 주문 상태 관리
- `PENDING_PAYMENT`: 결제 대기 중
- `COMPLETED`: 결제 완료
- `CANCELLED`: 주문 취소

### 4. 결제 상태 관리
- `PENDING`: 결제 대기
- `PAID`: 결제 완료
- `FAILED`: 결제 실패
- `REFUNDED`: 환불 완료

### 5. 에러 처리 플로우
- 포인트 잔액 부족 시 적절한 에러 메시지 반환 및 결제 중단
- 결제 실패 시 상세한 실패 사유 제공 및 롤백 처리
- 주문 조회 시 존재하지 않는 주문에 대한 처리

### 6. 결제 취소/환불 플로우

#### 6-1. 환불 처리 단계
1. 결제 상태 확인 (PAID만 환불 가능)
2. 사용한 포인트 복구 (point_transactions에서 SPENT 타입 거래 확인)
3. 적립된 포인트 취소 (point_transactions에서 EARNED 타입 거래 확인)
4. 주문 상태를 `CANCELLED`로 변경
5. 결제 상태를 `REFUNDED` 로 변경
6. 환불 레코드 생성

#### 6-2. 멤버십 등급 갱신 (환불 후)
- 총 결제 금액 재계산 (환불된 결제는 제외)
- 총 결제 금액에 따른 등급 재결정
- 멤버십 등급 자동 업데이트 (다운그레이드 가능)

---

## 플로우별 상태 변화

### 주문 상태 변화
```
생성 → PENDING_PAYMENT → [결제 성공] → COMPLETED
                    ↓
              [결제 실패] → PENDING_PAYMENT (유지)
                    ↓
              [환불 요청] → CANCELLED
```

### 결제 상태 변화
```
생성 → PENDING → [결제 성공] → PAID → [환불 요청] → REFUNDED
              ↓
        [결제 실패] → FAILED
```

### 멤버십 등급 변화
```
결제 완료 → 총 결제 금액 증가 → 등급 재계산 → 등급 업그레이드 가능
결제 취소 → 총 결제 금액 감소 → 등급 재계산 → 등급 다운그레이드 가능
```

---

## 참고사항

- **API 엔드포인트 상세 정보**: `api-endpoints.md` 파일 참고
- **트랜잭션 관리**: 주문 생성, 포인트 차감, 결제 처리는 하나의 트랜잭션으로 관리
- **멤버십 등급 자동 갱신**: 결제 완료 및 취소 시 자동으로 총 결제 금액을 재계산하여 등급 업데이트

