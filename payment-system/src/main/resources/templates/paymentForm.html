<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ë¬¸ ê¸ˆì•¡ ê³„ì‚°ê¸°</title>
    <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
</head>
<body>
<div class="container">
    <div class="input-group">
        <label for="orderId">ì£¼ë¬¸ ID</label>
        <input type="text" id="orderId" placeholder="order_id: 1">

        <button id="applyOrderBtn">ì ìš©</button>
    </div>
    <div class="input-group">
        <label for="totalAmount">ì£¼ë¬¸ ì´ê¸ˆì•¡</label>
        <input type="number" id="totalAmount" placeholder="ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”">
    </div>

    <div>
        <label>ë³´ìœ  í¬ì¸íŠ¸</label><br>
        <input type="number" id="userPoint" value="10000" readonly>
    </div>

    <div class="input-group">
        <label for="points">ì‚¬ìš©í•  í¬ì¸íŠ¸</label>
        <input type="number" id="points" placeholder="í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
    </div>

    <div class="result">
        <div class="result-label">ìµœì¢… ê²°ì œ ê¸ˆì•¡</div>
        <div class="result-formula" id="formula">-</div>
        <div class="result-amount" id="finalAmount">-</div>
    </div>

    <div style="margin-top: 16px;">
        <button id="getOrdersBtn">ì£¼ë¬¸ ì¡°íšŒ</button>
        <button id="getPaymentsBtn">ê²°ì œ ì¡°íšŒ</button>
        <button id="paymentBtn">ê²°ì œí•˜ê¸°</button>
    </div>

</div>

<script th:inline="javascript">

    const STORE_ID = [[${storeId}]];       // ì„œë²„ì—ì„œ model.addAttributeë¡œ ì „ë‹¬í•œ storeId
    const CHANNEL_KEY = [[${channelKey}]]; // ì„œë²„ì—ì„œ model.addAttributeë¡œ ì „ë‹¬í•œ channelKey
    const USER_ID = [[${userId}]];         // ì„œë²„ì—ì„œ model.addAttributeë¡œ ì „ë‹¬í•œ userId (ìˆ«ì)
    const PAYMENT_ID = [[${paymentId}]];   // ì„œë²„ì—ì„œ model.addAttributeë¡œ ì „ë‹¬í•œ paymentId

    console.log(STORE_ID, CHANNEL_KEY, USER_ID, PAYMENT_ID);

</script>

<script>

    const API_BASE_URL = "http://localhost:8080";  //api ê³µí†µ ì‹œì‘ë¶€


    //dom Element ê°ì²´ ë°˜í™˜
    const totalAmountInput = document.getElementById('totalAmount');
    const pointsInput = document.getElementById('points');
    const finalAmountDisplay = document.getElementById('finalAmount');
    const formulaDisplay = document.getElementById('formula');
    const getOrdersBtn = document.getElementById('getOrdersBtn');
    const getPaymentsBtn = document.getElementById('getPaymentsBtn');
    const paymentBtn = document.getElementById('paymentBtn');
    const applyOrderBtn = document.getElementById('applyOrderBtn');

    // ì£¼ë¬¸ ì ìš© ë²„íŠ¼ ì´ë²¤íŠ¸ ì²˜ë¦¬ ë©”ì„œë“œ
    applyOrderBtn.addEventListener('click', async function () {
        const orderId = document.getElementById('orderId').value;

        if (!orderId) {
            alert("ì£¼ë¬¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        try {
            // ğŸ”¹ fetch API URL ë³€ê²½: /api/orders/{orderId}
            console.log(orderId)
            const res = await fetch(`${API_BASE_URL}/api/orders/${orderId}`);
            if (!res.ok) {
                alert("orderId ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const data = await res.json();

            //  ì„±ê³µ ì‹œ ì´ê¸ˆì•¡ input ìë™ ì„¸íŒ…
            totalAmountInput.value = data.totalAmount || 0;

            //  ìµœì¢… ê²°ì œ ê¸ˆì•¡ ê³„ì‚°
            calculateFinalAmount();

            alert("ì£¼ë¬¸ ì •ë³´ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.");

        } catch (e) {
            console.error(e);
            alert("ì„œë²„ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
        }
    });

    //ì£¼ë¬¸ ì¡°íšŒ ë²„íŠ¼ ì´ë°´íŠ¸ ì²˜ë¦¬ ë©”ì„œë“œ
    getOrdersBtn.addEventListener('click', async function () {

        try {
            const res = await fetch(`${API_BASE_URL}/api/orders`);
            if (!res.ok) {
                alert("ì£¼ë¬¸ ë¦¬ìŠ¤íŠ¸ ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            alert("ì£¼ë¬¸ ë¦¬ìŠ¤íŠ¸ê°€ ì¡°íšŒë¨");

        } catch (e) {
            console.error(e);
            alert("ì„œë²„ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
        }
    });

    // ìµœì¢… ê²°ì œ ê¸ˆì•¡ ê³„ì‚° í•¨ìˆ˜
    function calculateFinalAmount() {
        // ì£¼ë¬¸ ì´ ê¸ˆì•¡ì„ ìˆ«ìë¡œ ë³€í™˜
        const total = parseFloat(totalAmountInput.value) || 0;
        // ì‚¬ìš© í¬ì¸íŠ¸ ìˆ«ìë¡œ ë³€í™˜ (ì…ë ¥ì´ ì—†ìœ¼ë©´ 0ìœ¼ë¡œ ì²˜ë¦¬)
        const points = parseFloat(pointsInput.value) || 0;
        // ìµœì¢… ê²°ì œ ê¸ˆì•¡ (ì´ ê¸ˆì•¡ - í¬ì¸íŠ¸)
        const final = total - points;

        // ì…ë ¥ê°’ì´ ëª¨ë‘ ë¹„ì–´ìˆì„ ë•Œ ê²°ê³¼ í‘œì‹œ ì´ˆê¸°í™”
        if (totalAmountInput.value === '' && pointsInput.value === '') {
            formulaDisplay.textContent = ' ';
            finalAmountDisplay.textContent = ' ';
        } else {
            formulaDisplay.textContent = total.toLocaleString() + 'ì› - ' + points.toLocaleString() + 'ì›';
            finalAmountDisplay.textContent = '= ' + final.toLocaleString() + 'ì›';
        }
    }

    // ì´ ê¸ˆì•¡, í¬ì¸íŠ¸ ì…ë ¥ì‹œ ìë™ ê³„ì‚° í›„ ë°˜ì˜
    totalAmountInput.addEventListener('input', calculateFinalAmount);
    pointsInput.addEventListener('input', calculateFinalAmount);

    // ê²°ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
    // async function ì€ ë¹„ë™ê¸° í•¨ìˆ˜
    paymentBtn.addEventListener('click', async function (e) {
        e.preventDefault();
        const orderId = document.getElementById('orderId').value;
        const total = parseFloat(totalAmountInput.value) || 0;
        const points = parseFloat(pointsInput.value) || 0;
        const final = total - points;
        console.log(orderId, total, points, final);

        // ê²€ì¦ 1. í”„ë¡ íŠ¸ ë‹¨ì—ì„œì˜ ê²€ì¦ ì½”ë“œ: orderIdì™€ totalì´ ê¸°ì…ë˜ì§€ ì•Šì€ ê²½ìš°
        if (!orderId || total <= 0) {
            alert("ì£¼ë¬¸ IDì™€ ì´ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        // ê²€ì¦ 2. ì´ ê²°ì œ ê¸ˆì•¡ë³´ë‹¤ ì£¼ë¬¸ê¸ˆì•¡ì´ ë§ì€ ê²½ìš°
        if (final < 0) {
            alert('í¬ì¸íŠ¸ê°€ ì£¼ë¬¸ ê¸ˆì•¡ë³´ë‹¤ ë§ìŠµë‹ˆë‹¤.');
            return;
        }

        alert('ê²°ì œ ê¸ˆì•¡: ' + final.toLocaleString() + 'ì›\nê²°ì œë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.');
        // alert í™•ì¸ ë²„íŠ¼ì„ ëˆ„ë¥¸ í›„ì— ë°”ë¡œ ì‹¤í–‰ë˜ëŠ” ì½”ë“œ

        //
        // console.log(STORE_ID, CHANNEL_KEY, USER_ID, PAYMENT_ID);
        const redirectUrl = window.location.origin + window.location.pathname;

        // ì—¬ê¸°ì„œë¶€í„°ê°€ ì§„ì§œ PortOne ê²°ì œ ë¡œì§
        const response = await PortOne.requestPayment({
            storeId: STORE_ID,
            channelKey: CHANNEL_KEY,
            paymentId: PAYMENT_ID,
            orderName: `ì£¼ë¬¸ë²ˆí˜¸ ${orderId}`,
            totalAmount: final,  // ê²°ì œ ê¸ˆì•¡
            currency: "CURRENCY_KRW",  // ì›
            payMethod: 'CARD',
            pg: "inicis_v2",  // ì´ë‹ˆì‹œìŠ¤ PG
            customer: {
                customerId: USER_ID.toString(),
                fullName: "í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì",
                phoneNumber: "010-1234-5678",
                email: "test@example.com"
            },
            redirectUrl: redirectUrl, // ê²°ì œ ì™„ë£Œ í›„ ë¦¬ë‹¤ì´ë ‰íŠ¸ URL
            testMode: true,
            customData: {
                orderId: orderId
            }
        });

        console.log(response);

        // ê²°ì œê°€ ì‹¤íŒ¨í•˜ëŠ” ê²½ìš°
        if (response.code != null) {
            console.error("ê²°ì œ ì‹¤íŒ¨", response);
            return;
        }
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ê³„ì‚°
    calculateFinalAmount();
</script>
</body>
</html>
