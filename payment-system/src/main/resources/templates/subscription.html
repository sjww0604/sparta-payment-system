<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµ¬ë… ì„œë¹„ìŠ¤</title>
    <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
        }

        .shop-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand-logo {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .brand h2 {
            font-size: 18px;
            color: #444;
        }

        .badge {
            font-size: 11px;
            background: #e6f4ff;
            color: #1677ff;
            padding: 3px 8px;
            border-radius: 999px;
            border: 1px solid #bae0ff;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .user-id-input {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .user-id-input label {
            font-weight: 600;
            color: #333;
        }

        .user-id-input input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .user-id-input input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .subscription-status {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .subscription-status h3 {
            font-size: 14px;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .subscription-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .info-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
        }

        .info-item-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 4px;
        }

        .info-item-value {
            font-size: 16px;
            font-weight: 700;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-trialing {
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .status-active {
            background: linear-gradient(135deg, #52c41a 0%, #73d13d 100%);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .status-past-due {
            background: linear-gradient(135deg, #ff4d4f 0%, #ff7875 100%);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .status-canceled {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            opacity: 0.7;
        }

        .plans-section {
            margin-bottom: 30px;
        }

        .plans-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .plan-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 24px;
            background: #fafafa;
            transition: all 0.3s;
            position: relative;
        }

        .plan-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
            transform: translateY(-4px);
        }

        .plan-card.featured {
            border-color: #667eea;
            background: linear-gradient(135deg, #f0f4ff 0%, #ffffff 100%);
        }

        .plan-card.featured::before {
            content: "ì¶”ì²œ";
            position: absolute;
            top: -10px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }

        .plan-name {
            font-size: 24px;
            font-weight: 800;
            color: #222;
            margin-bottom: 8px;
        }

        .plan-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
            min-height: 40px;
        }

        .plan-price {
            font-size: 32px;
            font-weight: 800;
            color: #667eea;
            margin-bottom: 4px;
        }

        .plan-interval {
            font-size: 14px;
            color: #999;
            margin-bottom: 16px;
        }

        .plan-features {
            list-style: none;
            margin-bottom: 20px;
        }

        .plan-features li {
            padding: 8px 0;
            font-size: 14px;
            color: #555;
            border-bottom: 1px solid #f0f0f0;
        }

        .plan-features li:last-child {
            border-bottom: none;
        }

        .plan-features li::before {
            content: "âœ“ ";
            color: #52c41a;
            font-weight: 700;
            margin-right: 8px;
        }

        .plan-button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .plan-button.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .plan-button.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }

        .plan-button.secondary {
            background: #f0f0f0;
            color: #333;
        }

        .plan-button.secondary:hover {
            background: #e0e0e0;
        }

        .plan-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .payment-methods-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .payment-methods-section h3 {
            margin-bottom: 16px;
            color: #333;
        }

        .payment-method-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #e0e0e0;
        }

        .payment-method-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .payment-method-info span {
            font-weight: 600;
            color: #333;
        }

        .payment-method-info small {
            color: #666;
            font-size: 12px;
        }

        .default-badge {
            background: #52c41a;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
        }

        .invoice-history {
            margin-top: 24px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .invoice-history h3 {
            margin-bottom: 16px;
            color: #333;
            font-size: 18px;
        }

        .invoice-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .invoice-item-info {
            flex: 1;
        }

        .invoice-item-amount {
            font-weight: 700;
            color: #667eea;
        }

        .invoice-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .invoice-status.paid {
            background: #d4edda;
            color: #155724;
        }

        .invoice-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .invoice-status.failed {
            background: #f8d7da;
            color: #721c24;
        }

        .invoice-status.canceled {
            background: #e2e3e5;
            color: #383d41;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .result {
            margin-top: 30px;
            padding: 20px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }

        .result.success {
            background: #d4edda;
            border: 2px solid #c3e6cb;
            color: #155724;
        }

        .result.error {
            background: #f8d7da;
            border: 2px solid #f5c6cb;
            color: #721c24;
        }

        .result.info {
            background: #d1ecf1;
            border: 2px solid #bee5eb;
            color: #0c5460;
        }

        .result h3 {
            margin-bottom: 10px;
            font-size: 16px;
        }

        .result pre {
            background: rgba(0,0,0,0.05);
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
            margin-top: 10px;
        }

        .actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="shop-header">
        <div class="brand">
            <div class="brand-logo"></div>
            <h2>Sparta Subscription</h2>
        </div>
        <span class="badge">êµ¬ë… ì„œë¹„ìŠ¤</span>
    </div>

    <!-- ì‚¬ìš©ì ID ì…ë ¥ -->
    <div class="user-id-input">
        <label for="userIdInput">ì‚¬ìš©ì ID:</label>
        <input type="number" id="userIdInput" placeholder="ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ì„¸ìš”" value="1" min="1">
        <button class="btn-secondary" onclick="setUserId()">ì„¤ì •</button>
    </div>

    <h1>ğŸ“¦ êµ¬ë… ì„œë¹„ìŠ¤</h1>
    <p class="subtitle">ì›í•˜ëŠ” í”Œëœì„ ì„ íƒí•˜ê³  ìë™ ê²°ì œë¥¼ ì‹œì‘í•˜ì„¸ìš”</p>

    <!-- í˜„ì¬ êµ¬ë… ìƒíƒœ -->
    <div class="subscription-status" id="currentSubscriptionSection" style="display: none;">
        <h3>í˜„ì¬ êµ¬ë… ìƒíƒœ</h3>
        <div id="subscriptionStatusContent"></div>
        <div class="actions" style="margin-top: 16px;">
            <button class="btn-danger" onclick="cancelCurrentSubscription()">êµ¬ë… í•´ì§€</button>
            <button class="btn-secondary" onclick="loadInvoices()">ê²°ì œ ë‚´ì—­ ì¡°íšŒ</button>
        </div>
    </div>

    <!-- êµ¬ë… í”Œëœ ì„¹ì…˜ -->
    <div class="plans-section">
        <h2 class="section-title">êµ¬ë… í”Œëœ</h2>
        <div class="plans-grid" id="plansGrid">
            <p style="text-align: center; color: #666;">í”Œëœì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    </div>

    <!-- ê²°ì œ ìˆ˜ë‹¨ ì„¹ì…˜ -->
    <div class="payment-methods-section" id="paymentMethodsSection" style="display: none;">
        <h3>ë“±ë¡ëœ ê²°ì œ ìˆ˜ë‹¨</h3>
        <div id="paymentMethodsList"></div>
    </div>

    <!-- ê²°ì œ ë‚´ì—­ ì„¹ì…˜ -->
    <div class="invoice-history" id="invoiceHistorySection" style="display: none;">
        <h3>ê²°ì œ ë‚´ì—­</h3>
        <div id="invoiceHistoryContent"></div>
    </div>

    <div class="actions">
        <button class="btn-secondary" onclick="loadPlans()">í”Œëœ ìƒˆë¡œê³ ì¹¨</button>
        <button class="btn-secondary" onclick="loadSubscriptions()">êµ¬ë… ìƒíƒœ ìƒˆë¡œê³ ì¹¨</button>
        <button class="btn-secondary" onclick="loadPaymentMethods()">ê²°ì œ ìˆ˜ë‹¨ ì¡°íšŒ</button>
    </div>

    <div id="result" class="result"></div>
</div>

<script>
    const API_BASE_URL = '';
    // PortOne Store ID ë° Channel Key (í† ìŠ¤í˜ì´ë¨¼ì¸  ì •ê¸°ê²°ì œ ì±„ë„)
    // PortOne ê´€ë¦¬ì ì½˜ì†” > ì—°ë™ ê´€ë¦¬ > ì±„ë„ì—ì„œ í™•ì¸ ê°€ëŠ¥
    const STORE_ID = 'ë³¸ì¸ì˜ ë°œê¸‰í•œ í¬íŠ¸ì› store idë¥¼ ë„£ì–´ì£¼ì„¸ìš”';
    const CHANNEL_KEY = 'channel-key-6579eebb-e5d9-4c95-b130-3ab4aba15447';
    
    let USER_ID = 1; // ê¸°ë³¸ê°’
    let currentSubscription = null;
    let paymentMethods = [];

    // ì‚¬ìš©ì ID ì„¤ì •
    function setUserId() {
        const userIdInput = document.getElementById('userIdInput');
        const userId = parseInt(userIdInput.value);
        
        if (!userId || userId < 1) {
            showResult('error', 'âŒ ì…ë ¥ ì˜¤ë¥˜', 'ì˜¬ë°”ë¥¸ ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        USER_ID = userId;
        showResult('success', 'âœ… ì‚¬ìš©ì ID ì„¤ì • ì™„ë£Œ', `ì‚¬ìš©ì IDê°€ ${USER_ID}ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        
        // êµ¬ë… ìƒíƒœ ë° ê²°ì œ ìˆ˜ë‹¨ ìƒˆë¡œê³ ì¹¨
        setTimeout(() => {
            loadSubscriptions();
            loadPaymentMethods();
        }, 500);
    }

    // ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
    function showResult(type, title, message, data = null) {
        const resultDiv = document.getElementById('result');
        resultDiv.className = `result ${type}`;
        resultDiv.style.display = 'block';

        let html = `<h3>${title}</h3><p>${message}</p>`;
        if (data) {
            html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
        resultDiv.innerHTML = html;

        resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // êµ¬ë… í”Œëœ ëª©ë¡ ì¡°íšŒ
    async function loadPlans() {
        try {
            const response = await fetch(`${API_BASE_URL}/api/plans/active`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const plans = await response.json();
            displayPlans(plans);
        } catch (error) {
            console.error('í”Œëœ ì¡°íšŒ ì˜¤ë¥˜:', error);
            showResult('error', 'âŒ í”Œëœ ì¡°íšŒ ì‹¤íŒ¨', `ì˜¤ë¥˜: ${error.message}`);
        }
    }

    // í”Œëœ í‘œì‹œ
    function displayPlans(plans) {
        const plansGrid = document.getElementById('plansGrid');
        
        if (plans.length === 0) {
            plansGrid.innerHTML = '<p style="text-align: center; color: #666;">ë“±ë¡ëœ í”Œëœì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        plansGrid.innerHTML = plans.map((plan, index) => {
            const isFeatured = index === 1; // ë‘ ë²ˆì§¸ í”Œëœì„ ì¶”ì²œìœ¼ë¡œ í‘œì‹œ
            const billingIntervalText = plan.billingInterval === 'monthly' ? 'ì›”' : 'ë…„';
            const price = Math.floor(plan.price).toLocaleString();
            
            return `
                <div class="plan-card ${isFeatured ? 'featured' : ''}">
                    <div class="plan-name">${plan.name}</div>
                    <div class="plan-description">${plan.description || 'êµ¬ë… í”Œëœ'}</div>
                    <div class="plan-price">${price}ì›</div>
                    <div class="plan-interval">/${billingIntervalText}</div>
                    <ul class="plan-features">
                        <li>${plan.name} í”Œëœ í˜œíƒ</li>
                        <li>ìë™ ê²°ì œ ì‹œìŠ¤í…œ</li>
                        <li>${plan.trialPeriodDays > 0 ? plan.trialPeriodDays + 'ì¼ ë¬´ë£Œ ì²´í—˜' : 'ì¦‰ì‹œ ì‹œì‘'}</li>
                    </ul>
                    <button class="plan-button primary" onclick="subscribeToPlan(${plan.planId})" 
                            ${currentSubscription ? 'disabled' : ''}>
                        ${currentSubscription ? 'ì´ë¯¸ êµ¬ë… ì¤‘' : 'êµ¬ë…í•˜ê¸°'}
                    </button>
                </div>
            `;
        }).join('');
    }

    // êµ¬ë… ì‹ ì²­
    async function subscribeToPlan(planId) {
        if (!USER_ID) {
            showResult('error', 'âŒ ì‚¬ìš©ì ID í•„ìš”', 'ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        try {
            showResult('info', 'â³ êµ¬ë… ì²˜ë¦¬ ì¤‘...', 'ë¹Œë§í‚¤ë¥¼ ë°œê¸‰í•˜ê³  êµ¬ë…ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...');

            // 1. ê³ ìœ í•œ customerUid ìƒì„±
            const customerUid = `customer_${USER_ID}_${Date.now()}`;
            
            // 2. í”Œëœ ì •ë³´ ì¡°íšŒ
            const planResponse = await fetch(`${API_BASE_URL}/api/plans/${planId}`);
            if (!planResponse.ok) {
                throw new Error('í”Œëœ ì •ë³´ë¥¼ ì¡°íšŒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            const plan = await planResponse.json();

            // 3. PortOne ë¹Œë§í‚¤ ë°œê¸‰
            showResult('info', 'â³ ë¹Œë§í‚¤ ë°œê¸‰ ì¤‘...', 'ê²°ì œ ì°½ì´ ì—´ë¦½ë‹ˆë‹¤. ì¹´ë“œ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            
            // ì´ë‹ˆì‹œìŠ¤ V2 ì±„ë„ ì‚¬ìš© ì‹œ í•„ìˆ˜ íŒŒë¼ë¯¸í„°
            const issueId = `issue_${USER_ID}_${Date.now()}`;
            const issueName = `${plan.name} êµ¬ë… - ë¹Œë§í‚¤ ë°œê¸‰`;
            
            const billingKeyResponse = await PortOne.requestIssueBillingKey({
                storeId: STORE_ID,
                channelKey: CHANNEL_KEY,
                billingKeyMethod: 'CARD',
                customer: {
                    id: String(USER_ID),
                    fullName: 'ì‚¬ìš©ì',
                    email: `user${USER_ID}@example.com`,
                    phoneNumber: '010-0000-0000'
                },
                customerUid: customerUid,
                amount: plan.price,
                orderName: issueName,
                // ì´ë‹ˆì‹œìŠ¤ V2 ì±„ë„ ì‚¬ìš© ì‹œ í•„ìˆ˜ (í† ìŠ¤í˜ì´ë¨¼ì¸  ë“± ë‹¤ë¥¸ PGì‚¬ì—ì„œëŠ” ë¬´ì‹œë¨)
                issueName: issueName,
                issueId: issueId,
                // ë¦¬ë””ë ‰ì…˜ ë°©ì‹ ë¹Œë§í‚¤ ë°œê¸‰ ì‹œ í•„ìˆ˜: ê²°ì œ ì™„ë£Œ í›„ ëŒì•„ì˜¬ URL
                redirectUrl: window.location.href,
                testMode: true
            });

            console.log('ë¹Œë§í‚¤ ë°œê¸‰ ì‘ë‹µ:', billingKeyResponse);

            if (billingKeyResponse.code != null) {
                throw new Error(`ë¹Œë§í‚¤ ë°œê¸‰ ì‹¤íŒ¨: ${billingKeyResponse.message || billingKeyResponse.code}`);
            }

            // ë¹Œë§í‚¤ ì¶”ì¶œ (ì‘ë‹µ êµ¬ì¡°ì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
            let billingKey = null;
            if (billingKeyResponse.billingKey) {
                billingKey = billingKeyResponse.billingKey;
            } else if (billingKeyResponse.billingKeyInfo?.billingKey) {
                billingKey = billingKeyResponse.billingKeyInfo.billingKey;
            }
            
            console.log('ì¶”ì¶œëœ ë¹Œë§í‚¤:', billingKey);

            // 4. ê²°ì œ ìˆ˜ë‹¨ ë“±ë¡ (ë¹Œë§í‚¤ í¬í•¨)
            const paymentMethodData = {
                customerUid: customerUid,
                billingKey: billingKey, // ë¹Œë§í‚¤ ì €ì¥
                cardBrand: billingKeyResponse.card?.brand || 'UNKNOWN',
                last4: billingKeyResponse.card?.last4 || '0000',
                isDefault: true
            };

            const paymentMethodResponse = await fetch(
                `${API_BASE_URL}/api/payment-methods/user/${USER_ID}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(paymentMethodData)
                }
            );

            if (!paymentMethodResponse.ok) {
                const errorText = await paymentMethodResponse.text();
                throw new Error(`ê²°ì œ ìˆ˜ë‹¨ ë“±ë¡ ì‹¤íŒ¨: ${errorText}`);
            }

            const paymentMethod = await paymentMethodResponse.json();

            // 5. êµ¬ë… ìƒì„±
            const subscriptionData = {
                planId: planId,
                paymentMethodId: paymentMethod.methodId
            };

            const subscriptionResponse = await fetch(
                `${API_BASE_URL}/api/subscriptions/user/${USER_ID}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(subscriptionData)
                }
            );

            if (!subscriptionResponse.ok) {
                const errorText = await subscriptionResponse.text();
                throw new Error(`êµ¬ë… ìƒì„± ì‹¤íŒ¨: ${errorText}`);
            }

            const subscriptionResult = await subscriptionResponse.json();
            
            showResult('success', 'âœ… êµ¬ë… ì‹ ì²­ ì™„ë£Œ!', 
                `êµ¬ë…ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!<br>í”Œëœ: ${plan.name}<br>ìë™ ê²°ì œê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`, 
                subscriptionResult);
            
            // êµ¬ë… ìƒíƒœ ìƒˆë¡œê³ ì¹¨
            setTimeout(() => {
                loadSubscriptions();
                loadPaymentMethods();
            }, 1000);

        } catch (error) {
            console.error('êµ¬ë… ì‹ ì²­ ì˜¤ë¥˜:', error);
            showResult('error', 'âŒ êµ¬ë… ì‹ ì²­ ì‹¤íŒ¨', `ì˜¤ë¥˜: ${error.message}`);
        }
    }

    // êµ¬ë… ìƒíƒœ ì¡°íšŒ
    async function loadSubscriptions() {
        if (!USER_ID) {
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/api/subscriptions/user/${USER_ID}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const subscriptions = await response.json();
            const activeSubscription = subscriptions.find(sub => 
                sub.status === 'ACTIVE' || sub.status === 'TRIALING' || sub.status === 'PAST_DUE'
            );

            if (activeSubscription) {
                currentSubscription = activeSubscription;
                displayCurrentSubscription(activeSubscription);
            } else {
                currentSubscription = null;
                document.getElementById('currentSubscriptionSection').style.display = 'none';
            }
        } catch (error) {
            console.error('êµ¬ë… ìƒíƒœ ì¡°íšŒ ì˜¤ë¥˜:', error);
            showResult('error', 'âŒ êµ¬ë… ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨', `ì˜¤ë¥˜: ${error.message}`);
        }
    }

    // í˜„ì¬ êµ¬ë… ìƒíƒœ í‘œì‹œ
    function displayCurrentSubscription(subscription) {
        const section = document.getElementById('currentSubscriptionSection');
        const content = document.getElementById('subscriptionStatusContent');
        
        section.style.display = 'block';
        
        const statusText = {
            'TRIALING': 'ì²´í—˜ ì¤‘',
            'ACTIVE': 'í™œì„±',
            'PAST_DUE': 'ê²°ì œ ì‹¤íŒ¨',
            'CANCELED': 'ì·¨ì†Œë¨',
            'ENDED': 'ì¢…ë£Œë¨'
        };

        const statusClass = {
            'TRIALING': 'status-trialing',
            'ACTIVE': 'status-active',
            'PAST_DUE': 'status-past-due',
            'CANCELED': 'status-canceled',
            'ENDED': 'status-canceled'
        };

        const formatDate = (dateStr) => {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleString('ko-KR');
        };

        content.innerHTML = `
            <div class="subscription-info">
                <div class="info-item">
                    <div class="info-item-label">í”Œëœ</div>
                    <div class="info-item-value">${subscription.planName}</div>
                </div>
                <div class="info-item">
                    <div class="info-item-label">ìƒíƒœ</div>
                    <div class="info-item-value">
                        <span class="status-badge ${statusClass[subscription.status]}">${statusText[subscription.status] || subscription.status}</span>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-item-label">í˜„ì¬ ê¸°ê°„ ì‹œì‘</div>
                    <div class="info-item-value" style="font-size: 12px;">${formatDate(subscription.currentPeriodStart)}</div>
                </div>
                <div class="info-item">
                    <div class="info-item-label">í˜„ì¬ ê¸°ê°„ ì¢…ë£Œ</div>
                    <div class="info-item-value" style="font-size: 12px;">${formatDate(subscription.currentPeriodEnd)}</div>
                </div>
                ${subscription.trialEnd ? `
                <div class="info-item">
                    <div class="info-item-label">ì²´í—˜ ì¢…ë£Œì¼</div>
                    <div class="info-item-value" style="font-size: 12px;">${formatDate(subscription.trialEnd)}</div>
                </div>
                ` : ''}
            </div>
        `;
    }

    // êµ¬ë… í•´ì§€
    async function cancelCurrentSubscription() {
        if (!currentSubscription || !USER_ID) {
            showResult('error', 'âŒ ì˜¤ë¥˜', 'êµ¬ë… ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        if (!confirm('ì •ë§ êµ¬ë…ì„ í•´ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ? í•´ì§€ í›„ ìë™ ê²°ì œê°€ ì¤‘ë‹¨ë©ë‹ˆë‹¤.')) {
            return;
        }

        try {
            showResult('info', 'â³ êµ¬ë… í•´ì§€ ì¤‘...', 'êµ¬ë…ì„ í•´ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤...');

            const response = await fetch(
                `${API_BASE_URL}/api/subscriptions/user/${USER_ID}/cancel/${currentSubscription.subscriptionId}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                }
            );

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText);
            }

            const result = await response.json();
            
            showResult('success', 'âœ… êµ¬ë… í•´ì§€ ì™„ë£Œ', 'êµ¬ë…ì´ ì„±ê³µì ìœ¼ë¡œ í•´ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.', result);
            
            // êµ¬ë… ìƒíƒœ ìƒˆë¡œê³ ì¹¨
            setTimeout(() => {
                loadSubscriptions();
            }, 1000);

        } catch (error) {
            console.error('êµ¬ë… í•´ì§€ ì˜¤ë¥˜:', error);
            showResult('error', 'âŒ êµ¬ë… í•´ì§€ ì‹¤íŒ¨', `ì˜¤ë¥˜: ${error.message}`);
        }
    }

    // ê²°ì œ ìˆ˜ë‹¨ ì¡°íšŒ
    async function loadPaymentMethods() {
        if (!USER_ID) {
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/api/payment-methods/user/${USER_ID}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            paymentMethods = await response.json();
            displayPaymentMethods(paymentMethods);
        } catch (error) {
            console.error('ê²°ì œ ìˆ˜ë‹¨ ì¡°íšŒ ì˜¤ë¥˜:', error);
        }
    }

    // ê²°ì œ ìˆ˜ë‹¨ í‘œì‹œ
    function displayPaymentMethods(methods) {
        const section = document.getElementById('paymentMethodsSection');
        const list = document.getElementById('paymentMethodsList');
        
        if (methods.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';
        list.innerHTML = methods.map(method => `
            <div class="payment-method-item">
                <div class="payment-method-info">
                    <span>${method.cardBrand || 'ì¹´ë“œ'} ****${method.last4 || '0000'}</span>
                    ${method.isDefault ? '<span class="default-badge">ê¸°ë³¸</span>' : ''}
                    <small>${method.customerUid}</small>
                </div>
            </div>
        `).join('');
    }

    // ê²°ì œ ë‚´ì—­ ì¡°íšŒ
    async function loadInvoices() {
        if (!USER_ID) {
            showResult('error', 'âŒ ì‚¬ìš©ì ID í•„ìš”', 'ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        try {
            showResult('info', 'â³ ì¡°íšŒ ì¤‘...', 'ê²°ì œ ë‚´ì—­ì„ ì¡°íšŒí•˜ê³  ìˆìŠµë‹ˆë‹¤...');

            const response = await fetch(`${API_BASE_URL}/api/invoices/user/${USER_ID}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const invoices = await response.json();
            displayInvoices(invoices);
            
            showResult('success', 'âœ… ê²°ì œ ë‚´ì—­ ì¡°íšŒ ì™„ë£Œ', 
                `ì´ ${invoices.length}ê±´ì˜ ê²°ì œ ë‚´ì—­ì„ ì¡°íšŒí–ˆìŠµë‹ˆë‹¤.`);
        } catch (error) {
            console.error('ê²°ì œ ë‚´ì—­ ì¡°íšŒ ì˜¤ë¥˜:', error);
            showResult('error', 'âŒ ê²°ì œ ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨', `ì˜¤ë¥˜: ${error.message}`);
        }
    }

    // ê²°ì œ ë‚´ì—­ í‘œì‹œ
    function displayInvoices(invoices) {
        const section = document.getElementById('invoiceHistorySection');
        const content = document.getElementById('invoiceHistoryContent');
        
        section.style.display = 'block';
        
        if (invoices.length === 0) {
            content.innerHTML = '<p style="text-align: center; color: #666;">ê²°ì œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        const statusText = {
            'PAID': 'ê²°ì œ ì™„ë£Œ',
            'PENDING': 'ëŒ€ê¸° ì¤‘',
            'FAILED': 'ì‹¤íŒ¨',
            'CANCELED': 'ì·¨ì†Œë¨',
            'REFUNDED': 'í™˜ë¶ˆë¨'
        };

        const statusClass = {
            'PAID': 'paid',
            'PENDING': 'pending',
            'FAILED': 'failed',
            'CANCELED': 'canceled',
            'REFUNDED': 'canceled'
        };

        const formatDate = (dateStr) => {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleString('ko-KR');
        };

        content.innerHTML = invoices.map(invoice => {
            const amount = Math.floor(invoice.amount).toLocaleString();
            return `
                <div class="invoice-item">
                    <div class="invoice-item-info">
                        <div><strong>ì²­êµ¬ì„œ #${invoice.invoiceId}</strong></div>
                        <div style="font-size: 12px; color: #666; margin-top: 4px;">
                            ${formatDate(invoice.dueDate)} | 
                            <span class="invoice-status ${statusClass[invoice.status]}">${statusText[invoice.status] || invoice.status}</span>
                        </div>
                    </div>
                    <div class="invoice-item-amount">${amount}ì›</div>
                </div>
            `;
        }).join('');
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    window.addEventListener('load', async function() {
        try {
            // ê¸°ë³¸ ì‚¬ìš©ì ID ì„¤ì •
            const userIdInput = document.getElementById('userIdInput');
            if (userIdInput && userIdInput.value) {
                USER_ID = parseInt(userIdInput.value);
            }
            
            await Promise.all([
                loadPlans(),
                loadSubscriptions(),
                loadPaymentMethods()
            ]);
        } catch (error) {
            console.error('í˜ì´ì§€ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:', error);
            loadPlans();
        }
    });
</script>
</body>
</html>

